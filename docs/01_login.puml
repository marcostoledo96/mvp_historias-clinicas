@startuml
' Diagrama 01 - Login del doctor
' Sistema con autenticación JWT (JSON Web Tokens)
' Base de datos: PostgreSQL en Neon
title 01 - Login del doctor

actor Doctor
participant "Sistema Web" as Web
participant "Servidor (API REST)" as Server
database "PostgreSQL (Neon)" as DB

Doctor -> Web : Ingresa email y contraseña
Web -> Server : POST /api/auth/login { email, password }

note right of Server
  // Verifico que vengan los datos requeridos
  // Busco al usuario en la base de datos
end note

Server -> DB : SELECT * FROM usuarios\nWHERE email = $1 AND activo = true
DB --> Server : registro_usuario

alt usuario encontrado
  note right of Server
    // bcrypt.compare compara el texto plano
    // con el hash guardado en la base de datos
  end note
  
  Server -> Server : bcrypt.compare(password, usuario.password_hash)
  
  alt contraseña correcta
    note right of Server
      // Genero JWT access token (válido 1 hora)
      // y refresh token (válido 7 días)
      // Access token contiene: id, email, nombre, rol
      // Refresh token contiene: id, tipo='refresh'
    end note
    
    Server -> Server : jwt.sign(payload, JWT_SECRET)
    Server --> Web : HTTP 200 OK\n{ accessToken, refreshToken, usuario }
    
    note right of Web
      // Cliente guarda tokens en localStorage
      // localStorage.setItem('accessToken', ...)
      // localStorage.setItem('refreshToken', ...)
    end note
    
    Web -> Web : Guardar tokens en localStorage
    Web --> Doctor : Redirige a inicio.html
    
  else contraseña incorrecta
    Server --> Web : HTTP 401 Unauthorized\n{ error: "Credenciales inválidas" }
    Web --> Doctor : Muestra mensaje de error
  end
  
else usuario no encontrado
  Server --> Web : HTTP 404 Not Found\n{ error: "Usuario no encontrado" }
  Web --> Doctor : Muestra mensaje de error
end

note over Server, DB
  **Seguridad**: Las contraseñas se guardan con bcrypt (10 rounds)
  **Autenticación**: JWT stateless con access token (1h) y refresh token (7d)
  **Multitenancy**: Cada usuario pertenece a un `id_usuario` (aislamiento por usuario)
  **Tokens**: Se envían en header Authorization: Bearer <token> en cada petición
end note

@enduml
