@startuml
title
  Diagrama de Arquitectura - Sistema de Historias Clínicas MVP
  Vercel Serverless + PostgreSQL (Neon) + JWT Authentication
end title

' --- CLIENTE ---
node "Cliente Web (Doctor)" {
  [Navegador Web]
  
  frame "Frontend (Estático)" {
    [HTML + CSS]
    [JavaScript (Vanilla)]
    [Components (Header/Footer)]
    [JWT Storage\n(localStorage)]
  }
  
  [Navegador Web] --> [HTML + CSS]
  [Navegador Web] --> [JavaScript (Vanilla)]
  [Navegador Web] --> [Components (Header/Footer)]
  [JavaScript (Vanilla)] --> [JWT Storage\n(localStorage)] : Tokens
}

' --- VERCEL SERVERLESS ---
cloud "Vercel Platform" {+
  
  node "Frontend Hosting" {
    [Archivos estáticos\n(HTML/CSS/JS)]
  }
  
  node "Serverless Functions" {
    frame "API Routes (/api/*)" {
      [/api/auth/*\n(login, logout, perfil,\npregunta secreta)]
      [/api/pacientes/*\n(CRUD pacientes)]
      [/api/consultas/*\n(CRUD consultas)]
      [/api/turnos/*\n(FUTURO)]
    }
    
    frame "Controladores" {
      [authController.js]
      [pacientesController.js]
      [consultasController.js]
      [turnosController.js]
    }
    
    frame "Middlewares" {
      [verificarAuth\n(JWT verification)]
      [verificarAdmin]
      [validarCamposRequeridos]
    }
    
    frame "Modelos (DB Access)" {
      [Usuario.js]
      [Paciente.js]
      [Consulta.js]
      [Turno.js]
    }
    
    [/api/auth/*\n(login, logout, perfil,\npregunta secreta)] --> [Middlewares]
    [/api/pacientes/*\n(CRUD pacientes)] --> [Middlewares]
    [/api/consultas/*\n(CRUD consultas)] --> [Middlewares]
    
    [Middlewares] --> [authController.js]
    [Middlewares] --> [pacientesController.js]
    [Middlewares] --> [consultasController.js]
    
    [authController.js] --> [Usuario.js]
    [pacientesController.js] --> [Paciente.js]
    [consultasController.js] --> [Consulta.js]
    [turnosController.js] --> [Turno.js]
  }
}

' --- NEON DATABASE ---
database "Neon (PostgreSQL)" {
  frame "Base de Datos\nPostgreSQL" {
    [usuarios\n(con pregunta_secreta)]
    [pacientes\n(multitenancy)]
    [consultas\n(historias clínicas)]
    [turnos\n(FUTURO)]
  }
}

' --- CONEXIONES ---
[JavaScript (Vanilla)] --> [Archivos estáticos\n(HTML/CSS/JS)] : Fetch API\n(HTTP/HTTPS)
[Archivos estáticos\n(HTML/CSS/JS)] --> [API Routes (/api/*)] : REST API\n(JSON)

[Usuario.js] --> [usuarios\n(con pregunta_secreta)] : SQL Queries\n(pg Pool)
[Paciente.js] --> [pacientes\n(multitenancy)] : SQL Queries
[Consulta.js] --> [consultas\n(historias clínicas)] : SQL Queries
[Turno.js] --> [turnos\n(FUTURO)] : SQL Queries

' --- NOTAS ---
note right of [Navegador Web]
  **Frontend Simple:**
  - HTML5 + CSS3 (styles.css)
  - JavaScript Vanilla (sin frameworks)
  - Componentes reutilizables (header/footer)
  - Fetch API para comunicación
  - JWT tokens en localStorage
  - Authorization header en cada request
end note

note right of [Serverless Functions]
  **Backend (serverless):**
  - Node.js + Express en funciones Vercel
  - Autenticación JWT stateless (access + refresh tokens)
  - Bcrypt para contraseñas y respuesta secreta
  - Multitenancy: aislamiento por `id_usuario` (cada médico ve sólo lo suyo)
  - Sin estado de sesión en servidor
end note

note right of [Neon (PostgreSQL)]
  **Base de Datos:**
  - PostgreSQL Neon (cloud)
  - Pool de conexiones (pg)
  - Migraciones versionadas
  - Aislamiento: `id_usuario` en pacientes/consultas/turnos
  - Campos de recuperación (pregunta secreta)
  - NO requiere tabla de sesiones (JWT stateless)
end note

note bottom of [authController.js]
  **Autenticación JWT:**
  - Login con email + password (bcrypt.compare)
  - Genera access token (1h) y refresh token (7d)
  - Endpoint /refresh para renovar tokens
  - Recuperación con pregunta secreta
  - Logout lógico (cliente borra tokens)
end note

note bottom of [verificarAuth\n(JWT verification)]
  **Seguridad:**
  - JWT verificado con jsonwebtoken
  - Middleware extrae token de Authorization header
  - req.user contiene datos decodificados del token
  - Admin-only endpoints con verificarAdmin
  - Validación de campos requeridos
end note

@enduml

