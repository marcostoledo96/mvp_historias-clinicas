@startuml
' Diagrama 03 - Crear usuario (solo administradores)
' Endpoint protegido: solo usuarios con rol 'admin' pueden crear usuarios
title 03 - Crear usuario (Registro)

actor Admin
participant "Sistema Web" as Web
participant "Servidor (API REST)" as Server
database "PostgreSQL (Neon)" as DB

Admin -> Web : Accede a configuracion.html\n(sección Administración)

note right of Web
  Solo visible para usuarios
  con rol 'admin'
end note

Admin -> Web : Completa formulario:\nnombre, email, password, rol
Web -> Server : POST /api/auth/registro\n{ nombre_completo, email, password, rol }

note right of Server
  // Verifico que el usuario logueado sea admin
  // usando el middleware verificarAdmin()
end note

Server -> Server : Verifica req.session.usuario.rol === 'admin'

alt usuario es admin
  
  Server -> DB : SELECT * FROM usuarios\nWHERE email = $1 AND id_usuario = $2
  DB --> Server : resultado
  
  alt email no existe para este id_usuario
    
    note right of Server
      // Hasheo la contraseña con bcrypt (10 rounds)
      // y creo el usuario asociado al id_usuario del admin
    end note
    
    Server -> Server : bcrypt.hash(password, 10)
    Server -> DB : INSERT INTO usuarios\n(nombre, email, password_hash, rol, id_usuario)\nVALUES ($1, $2, $3, $4, $5)
    DB --> Server : id_usuario
    
    Server --> Web : HTTP 201 Created\n{ id_usuario, mensaje: "Usuario creado" }
    Web --> Admin : Muestra confirmación
    
  else email duplicado
    Server --> Web : HTTP 409 Conflict\n{ error: "Email ya registrado" }
    Web --> Admin : Muestra alerta
  end
  
else usuario no es admin
  Server --> Web : HTTP 403 Forbidden\n{ error: "Solo administradores pueden crear usuarios" }
  Web --> Admin : Muestra error de permisos
end

note over Server, DB
  **Seguridad**: Solo administradores pueden crear usuarios
  **Multitenancy**: Usuarios creados en el mismo `id_usuario` del admin (aislamiento por usuario)
  **Contraseñas**: Hasheadas con bcrypt antes de guardar
end note

@enduml
